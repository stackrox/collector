version: 2

jobs:
  build:
    docker:
    - image: google/cloud-sdk:206.0.0-alpine
    parallelism: 4
    working_directory: /go/src/github.com/stackrox/collector

    steps:
    - run:
        name: Google Authenticate
        working_directory: /root/.config/gcloud
        command: |
          echo "$GOOGLE_CREDENTIALS_KERNEL_CACHE" > auth.json
          gcloud config set core/project stackrox-ci
          gcloud config set compute/region us-east1
          gcloud config set compute/zone us-east1-d
          gcloud auth activate-service-account --key-file auth.json
          gcloud auth list

    - run:
        name: Install Build Dependencies
        working_directory: /tmp
        command: |
          wget --quiet https://download.docker.com/linux/static/stable/x86_64/docker-18.06.0-ce.tgz
          tar -xf docker-18.06.0-ce.tgz
          install docker/docker /usr/bin
          rm -f docker-18.06.0-ce.tgz
          apk add --no-cache make

    - setup_remote_docker
    - run:
        name: Login to Docker Hub
        command: docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"

    - checkout

    - run:
        name: Download Package Cache
        command: |
          make -C kernel-modules download-package-cache
          find /packages
          du -h /packages

    - run:
        name: Pack Docker Volumes
        command: |
          docker create -v /packages --name packages alpine:3.8 /bin/true
          echo 'Packing packages volume'
          time docker cp /packages/. packages:/packages
          docker create -v /sysdig-src --name sysdig alpine:3.8 /bin/true
          echo 'Packing sysdig volume'
          time docker cp sysdig/src/. sysdig:/sysdig-src
          docker create -v /output --name output alpine:3.8 /bin/true

    - run:
        name: Build Builder Image
        command: |
          make -C kernel-modules build-container

    - run:
        name: Build all
        command: ./scripts/ci-build

    - run:
        name: Copy Built Modules to Workspace
        working_directory: kernel-modules
        command: |
          mkdir -p container/kernel-modules/
          docker cp output:/output/. container/kernel-modules/
          find container/kernel-modules

    - persist_to_workspace:
        root: kernel-modules/container
        paths:
        - kernel-modules

  image:
    docker:
    - image: circleci/golang:1.10.3
    working_directory: /go/src/github.com/stackrox/collector

    steps:
    - setup_remote_docker
    - run:
        name: Login to Docker Hub
        command: docker login -u "$DOCKER_USER" -p "$DOCKER_PASS"

    - checkout

    - attach_workspace:
        at: kernel-modules/container

    - run:
        name: Sanity Check
        command: find kernel-modules/container

    - run:
        name: Build kernel-modules Docker Image
        working_directory: /go/src/github.com/stackrox/collector/kernel-modules/container
        command: docker build -t stackrox/kernel-modules:latest .

    - run:
        name: Sanity Check Kernel Modules Docker Image
        command: docker run --rm -it --entrypoint find stackrox/kernel-modules:latest /kernel-modules

workflows:
  version: 2
  build:
    jobs:
    - build:
        filters:
          tags:
            only: /.*/
    - image:
        requires:
        - build
        filters:
          tags:
            only: /.*/
