export COLLECTOR_TAG="$1"
shift

source make-golang-dist
cat >/tmp/roottodo.$$ <<EOF
cd /tmp
mkdir tmpdir
cd tmpdir
tar xfz /home/circleci/.srbcache/dist/golang/go1.11.5.linux-amd64.tar.gz
chown -R root:root go && mv go ../gosys && cd .. && rm -rf tmpdir
mkdir -m 777 /tmp/go
EOF
sudo bash -c "bash /tmp/roottodo.$$ && rm /tmp/roottodo.$$"

set -e
export GOPATH=/tmp/go
export PATH="/tmp/gosys/bin:$GOPATH/bin:/usr/local/bin:$PATH"
cd
DN=$GOPATH/src/github.com/stackrox && mkdir -p $DN && mv collector $DN
cd $DN/collector/collector
go get -u github.com/jstemmer/go-junit-report
curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
sudo curl -L "https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
if make integration-tests-ebpf ; then
  RESULT=0
else
  RESULT=1
fi
make integration-test-report
exit $RESULT
