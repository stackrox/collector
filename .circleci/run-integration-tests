export COLLECTOR_VERSION="$1"
shift

source make-golang-dist
cat >/tmp/roottodo.$$ <<EOF
cd /usr/local
mkdir tmpdir
cd tmpdir
tar xfz /home/circleci/.srbcache/dist/golang/go1.11.5.linux-amd64.tar.gz
chown -R root:root go && mv go .. && cd .. && rm -rf tmpdir
mkdir /go -m 777
EOF
sudo bash -c "bash /tmp/roottodo.$$ && rm /tmp/roottodo.$$"

set -e
export GOPATH=/go
export PATH="/usr/local/go/bin:$GOPATH/bin:/usr/local/bin:$PATH"
cd
DN=$GOPATH/src/github.com/stackrox && mkdir -p $DN && mv collector $DN
cd $DN/collector/collector
go get -u github.com/jstemmer/go-junit-report
curl https://raw.githubusercontent.com/golang/dep/master/install.sh | sh
export COLLECTOR_TAG="snapshot-$COLLECTOR_VERSION"
sudo curl -L "https://github.com/docker/compose/releases/download/1.22.0/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
sudo chmod +x /usr/local/bin/docker-compose
# export ROX_COLLECTOR_NO_COLLECTOR=true  # for non-collector perf benchmarking
make integration-tests-ebpf integration-test-report
