name: Build the collector full image

on:
  workflow_call:
    inputs:
      collector-tag:
        type: string
        required: true
        description: |
          The tag used to build the collector image, usually extracted from the
          collector-slim.yml workflow

jobs:
  build-collector-full:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'push' || contains(github.event.pull_request.labels.*.name, 'build-full-images') }}
    steps:
      - uses: actions/checkout@v3

      - name: Setup kernel driver cache
        uses: actions/cache@v3
        with:
          path: /tmp/kernel-modules/
          key: kernel-modules-test-v0

      - name: Restore built drivers
        uses: actions/download-artifact@v3
        if: ${{ github.event_name == 'pull_request' }}
        with:
          name: built-drivers
          path: /tmp/built-drivers/

      - name: Set driver version
        run: |
          echo "DRIVER_VERSION=$(cat ${{ github.workspace }}/kernel-modules/MODULE_VERSION)" >> "$GITHUB_ENV"

      - name: Move drivers to the docker context
        run: |
          CACHED_DRIVERS_DIR="/tmp/kernel-modules/${DRIVER_VERSION}/"
          BUILT_DRIVERS_DIR="/tmp/built-drivers/${DRIVER_VERSION}/"
          CONTEXT_DRIVERS_DIR="${{ github.workspace }}/kernel-modules/container/kernel-modules"

          find "${CACHED_DRIVERS_DIR}" -type f -exec mv -t "${CONTEXT_DRIVERS_DIR}" {} +
          find "${BUILT_DRIVERS_DIR}" -type f -exec mv -t "${CONTEXT_DRIVERS_DIR}" {} +

      - name: Pull slim image and build full image
        run: |
          docker build \
            --target=probe-layer-5 \
            --tag quay.io/stackrox-io/collector:${{ inputs.collector-tag }} \
            --build-arg collector_repo=quay.io/stackrox-io/collector \
            --build-arg collector_version=${{ inputs.collector-tag }} \
            --build-arg module_version="${DRIVER_VERSION}" \
            --build-arg max_layer_size=300 \
            --build-arg max_layer_depth=5 \
            "${{ github.workspace }}/kernel-modules/container"

      - name: Login to quay.io/stackrox-io
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_STACKROX_IO_RW_USERNAME }}
          password: ${{ secrets.QUAY_STACKROX_IO_RW_PASSWORD }}

      - name: Push collector to stackrox-io
        run: |
          docker tag quay.io/stackrox-io/collector:${{ inputs.collector-tag }} \
           quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-latest

          docker push quay.io/stackrox-io/collector:${{ inputs.collector-tag }}
          docker push quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-latest

      - name: Login to quay.io/rhacs-eng
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_RHACS_ENG_RW_USERNAME }}
          password: ${{ secrets.QUAY_RHACS_ENG_RW_PASSWORD }}

      - name: Push collector to rhacs-eng
        run: |
          docker tag quay.io/stackrox-io/collector:${{ inputs.collector-tag }} \
           quay.io/rhacs-eng/collector:${{ inputs.collector-tag }}
          docker tag quay.io/stackrox-io/collector:${{ inputs.collector-tag }} \
           quay.io/rhacs-eng/collector:${{ inputs.collector-tag }}-latest

          docker push quay.io/rhacs-eng/collector:${{ inputs.collector-tag }}
          docker push quay.io/rhacs-eng/collector:${{ inputs.collector-tag }}-latest

  retag-collector-full:
    runs-on: ubuntu-latest
    if: ${{ github.event_name == 'pull_request' && !contains(github.event.pull_request.labels.*.name, 'build-full-images') }}

    steps:
      - name: Pull slim image
        run: |
          docker pull quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-slim

      - name: Login to quay.io/stackrox-io
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_STACKROX_IO_RW_USERNAME }}
          password: ${{ secrets.QUAY_STACKROX_IO_RW_PASSWORD }}

      - name: Retag and push collector to stackrox-io
        run: |
          docker tag \
            quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-slim \
            quay.io/stackrox-io/collector:${{ inputs.collector-tag }}
          docker tag \
            quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-slim \
            quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-latest

          docker push quay.io/stackrox-io/collector:${{ inputs.collector-tag }}
          docker push quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-latest

      - name: Login to quay.io/rhacs-eng
        uses: docker/login-action@v2
        with:
          registry: quay.io
          username: ${{ secrets.QUAY_RHACS_ENG_RW_USERNAME }}
          password: ${{ secrets.QUAY_RHACS_ENG_RW_PASSWORD }}

      - name: Retag and push collector to rhacs-eng
        run: |
          docker tag \
            quay.io/stackrox-io/collector:${{ inputs.collector-tag }}-slim \
            quay.io/rhacs-eng/collector:${{ inputs.collector-tag }}

          docker push quay.io/rhacs-eng/collector:${{ inputs.collector-tag }}
