name: Build collector drivers

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master

jobs:
  split-tasks:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
        with:
          submodules: false

      - name: Patch files
        run: |
          # Initialize just the falco submodule
          git submodule update --init ${{ github.workspaceÂ }}/falcosecurity-libs

          CHECKOUT_BEFORE_PATCHING=false \
          ${{ github.workspace }}/kernel-modules/dockerized/scripts/patch-files.sh \
            ${{ github.head_ref }} \
            false \
            ${{ github.workspace }} \
            kernel-modules/build/prepare-src \
            /tmp

      - name: Get build tasks
        run: |
          USE_KERNELS_FILE=true \
          KERNELS_FILE=${{ github.workspace }}/kernel-modules/KERNEL_VERSIONS \
          OUTPUT_DIR=/tmp \
          CACHE_DIR=/tmp \
          BLOCKLIST_DIR=${{ github.workspace }}/kernel-modules \
          SCRIPTS_DIR=${{ github.workspace }}/kernel-modules/build \
            ${{ github.workspace }}/kernel-modules/dockerized/scripts/get-build-tasks.sh

          mkdir -p /tmp/tasks
          mv /tmp/build-tasks /tmp/tasks/all

          TASKS_DIR=/tmp/tasks \
          RHEL8_BUILDERS=8 \
            ${{ github.workspace }}/.openshift-ci/drivers/scripts/kernel-splitter.py

          ls -la /tmp/tasks/**/**
