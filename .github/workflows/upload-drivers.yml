name: Upload drivers to GCP

on:
  workflow_call:

jobs:
  upload-drivers:
    runs-on: ubuntu-latest

    steps:
      - name: Restore built drivers
        uses: actions/download-artifact@v3
        with:
          name: built-drivers
          path: /tmp/output/

      - name: Choose destination bucket
        id: gcp-bucket
        run: |
          # TODO: Move these buckets to the proper ones when we completely switch off OSCI
          if [[ ${{ github.event_name }} == "pull_request" ]]; then
            echo "gcp-bucket=mauro-drivers-test/pr-builds/${GITHUB_HEAD_REF}/${{ github.run_id }}" >> "$GITHUB_OUTPUT"
          else
            echo "gcp-bucket=mauro-drivers-test/drivers" >> "$GITHUB_OUTPUT"
          fi

      - name: Authenticate with GCP
        uses: 'google-github-actions/auth@v1'
        with:
          credentials_json: '${{ secrets.GOOGLE_CREDENTIALS_COLLECTOR_SVC_ACCT }}'

      - name: Push drivers
        uses: 'google-github-actions/upload-cloud-storage@v1'
        with:
          path: /tmp/output/
          parent: false
          destination: ${{ steps.gcp-bucket.outputs.gcp-bucket }}
