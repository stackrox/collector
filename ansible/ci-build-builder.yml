---
- name: Build and push collector image
  hosts: "{{ build_hosts | default('all') }}"

  environment:
    BUILD_BUILDER_IMAGE: "true"
    COLLECTOR_BUILDER_TAG: "{{ collector_builder_tag }}"
    PLATFORM: "linux/{{ arch }}"

  vars:
    collector_root: "{{ ansible_env.HOME }}/collector"
    local_branch: local

  tasks:
    - name: Clone repository
      ansible.builtin.git:
        repo: https://github.com/stackrox/collector
        dest: "{{ collector_root }}"
        # We fetch the ref (either master, or pull/<ID>/merge) and then
        # create a local branch based on that. Doing it this way, rather
        # than with commit hashes, prevents "reference is not a tree" errors
        version: "{{ local_branch }}"
        refspec: "+{{ collector_git_ref | replace('refs/', '') }}:{{ local_branch }}"
        recursive: true
      when: clone_repository

    - name: Build the collector builder image
      community.general.make:
        chdir: "{{ ansible_env.GITHUB_WORKSPACE | default(collector_root) }}"
        target: builder

    - name: Retag and push to stackrox-io
      ansible.builtin.include_role:
        name: push-image
      vars:
        original_image: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}"
        target_image: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
        untag_original: true
        username: "{{ stackrox_io_username }}"
        password: "{{ stackrox_io_password }}"

    - name: Retag and push to rhacs-eng
      ansible.builtin.include_role:
        name: push-image
      vars:
        original_image: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
        target_image: "quay.io/rhacs-eng/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
        untag_original: false
        username: "{{ rhacs_eng_username }}"
        password: "{{ rhacs_eng_password }}"

    - name: Print builder images pushed
      ansible.builtin.debug:
        msg:
          - "Pushed the following builder images:"
          - "  quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
          - "  quay.io/rhacs-eng/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
