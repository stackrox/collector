---
- name: Build and push collector image
  hosts: "{{ build_hosts | default('all') }}"

  environment:
    BUILD_BUILDER_IMAGE: "true"
    COLLECTOR_BUILDER_TAG: "{{ collector_builder_tag }}"
    PLATFORM: "linux/{{ arch }}"

  vars:
    collector_root: "{{ ansible_env.HOME }}/collector"
    local_branch: local

  tasks:
    - name: Wrap docker with crane
      shell:
        cmd: |
          # Taken from https://github.com/actions/runner-images/issues/13474#issuecomment-3893588930
          #
          # Docker 29 containerd pushes OCI manifests that ECR rejects with 403
          # Bypass docker push: save image to tarball, push with crane
          CRANE_VERSION=v0.20.7
          CRANE_PLATFORM=${PLATFORM}
          case "${CRANE_PLATFORM}" in
            amd64) CRANE_PLATFORM=x86_64 ;;
          esac
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${CRANE_VERSION}/go-containerregistry_Linux_${CRANE_PLATFORM}.tar.gz" \
            | tar xz -C /usr/local/bin crane

          REAL_DOCKER=$(which docker)
          cat > /usr/local/bin/docker <<'WRAPPER'
          #!/bin/sh
          if [ "$1" = "push" ]; then
            shift
            # Parse image reference (skip flags like --platform)
            IMAGE=""
            for arg in "$@"; do
              case "$arg" in
                --*) ;;
                *) IMAGE="$arg" ;;
              esac
            done
            echo "=== crane push workaround for Docker 29 / ECR OCI ==="
            TMPTAR=$(mktemp /tmp/image-XXXXXX.tar)
            REAL_DOCKER save "$IMAGE" -o "$TMPTAR" && crane push "$TMPTAR" "$IMAGE"
            RC=$?
            rm -f "$TMPTAR"
            exit $RC
          else
            exec REAL_DOCKER "$@"
          fi
          WRAPPER
          sed -i "s|REAL_DOCKER|$REAL_DOCKER|g" /usr/local/bin/docker
          chmod +x /usr/local/bin/docker

    - name: Build the collector builder image
      community.general.make:
        chdir: "{{ ansible_env.GITHUB_WORKSPACE | default(collector_root) }}"
        target: builder

    - name: Retag collector builder image to arch specific
      community.docker.docker_image:
        name: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}"
        repository: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
        source: local

    - name: Untag collector builder image to prevent issues with multiarch
      community.docker.docker_image:
        name: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}"
        state: absent

    - name: Login to quay.io
      community.docker.docker_login:
        registry_url: quay.io
        username: "{{ stackrox_io_username }}"
        password: "{{ stackrox_io_password }}"

    - name: Push builder image to quay.io/stackrox-io
      community.docker.docker_image:
        name: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
        push: true
        source: local

    - name: Login to quay.io
      community.docker.docker_login:
        registry_url: quay.io
        username: "{{ rhacs_eng_username }}"
        password: "{{ rhacs_eng_password }}"

    - name: Push builder image to quay.io/rhacs-eng
      community.docker.docker_image:
        name: "quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
        repository: "quay.io/rhacs-eng/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
        push: true
        source: local

    - name: Print builder images pushed
      debug:
        msg:
          - "Pushed the following builder images:"
          - "  quay.io/stackrox-io/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"
          - "  quay.io/rhacs-eng/collector-builder:{{ ansible_env.COLLECTOR_BUILDER_TAG }}-{{ arch }}"

    - name: Logout of quay.io
      community.docker.docker_login:
        registry_url: quay.io
        state: absent
      when: true
